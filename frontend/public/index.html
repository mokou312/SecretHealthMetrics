<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthHub - Regional Health Matching</title>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Health Metrics ‚Äî FHE Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #1e293b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 50px;
            animation: fadeInDown 0.7s ease-out;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            margin-bottom: 12px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            letter-spacing: -0.5px;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .header-content {
            flex: 1;
            text-align: center;
        }

        .header button {
            min-width: 140px;
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .header button:hover {
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 28px;
            margin-bottom: 28px;
        }

        .card {
            background: white;
            border-radius: 18px;
            padding: 28px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.12);
            transition: all 0.35s cubic-bezier(0.165, 0.84, 0.44, 1);
            animation: scaleIn 0.6s ease-out forwards;
            opacity: 0;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #06b6d4 0%, #0891b2 100%);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.6s ease-out;
        }

        .card:nth-child(1) { animation-delay: 0.15s; }
        .card:nth-child(2) { animation-delay: 0.3s; }

        .card:hover {
            transform: translateY(-12px);
            box-shadow: 0 18px 50px rgba(6, 182, 212, 0.2);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            margin-bottom: 28px;
            gap: 16px;
        }

        .card-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(8, 145, 178, 0.15) 100%);
            border: 2px solid rgba(6, 182, 212, 0.3);
        }

        .card:nth-child(2) .card-icon {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.15) 100%);
            border: 2px solid rgba(16, 185, 129, 0.3);
        }

        .card-title {
            font-size: 1.35rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .card-subtitle {
            font-size: 0.85rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #f8fafc;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #06b6d4;
            background: white;
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .btn {
            width: 100%;
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(6, 182, 212, 0.35);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.35);
        }

        .status-text {
            font-size: 0.9rem;
            color: #06b6d4;
            margin-top: 8px;
        }

        .info-box {
            background: rgba(6, 182, 212, 0.05);
            border: 1px solid rgba(6, 182, 212, 0.2);
            border-radius: 10px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #1e293b;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }

        .console-section {
            background: white;
            border-radius: 18px;
            padding: 28px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.12);
            margin-top: 28px;
            animation: scaleIn 0.6s ease-out 0.45s forwards;
            opacity: 0;
            position: relative;
            overflow: hidden;
        }

        .console-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #06b6d4 0%, #0891b2 100%);
        }

        .console-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
        }

        .console-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
        }

        .console-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }

        #console {
            background: #0f172a;
            color: #10b981;
            padding: 18px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.7;
            max-height: 380px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            border: 1px solid #1e293b;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .console-clear {
            margin-top: 16px;
        }

        .console-clear button {
            background: #64748b;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            transition: all 0.3s ease;
        }

        .console-clear button:hover {
            background: #475569;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .card {
                padding: 22px;
            }

            .form-group {
                margin-bottom: 18px;
            }
        }

        #console::-webkit-scrollbar {
            width: 8px;
        }

        #console::-webkit-scrollbar-track {
            background: #1e293b;
            border-radius: 10px;
        }

        #console::-webkit-scrollbar-thumb {
            background: #06b6d4;
            border-radius: 10px;
        }

        #console::-webkit-scrollbar-thumb:hover {
            background: #0891b2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üîí Secret Health Metrics</h1>
                <p>FHE Demo ‚Äî Encrypted Health Matching</p>
            </div>
            <button id="btnConnect">Connect Wallet</button>
        </div>

        <div class="grid">
            <!-- Card 1: Submit Citizen -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üë§</div>
                    <div>
                        <div class="card-title">Submit Citizen</div>
                        <div class="card-subtitle">Encrypt health data</div>
                    </div>
                </div>

                <form>
                    <div class="form-group">
                        <label>Age Group</label>
                        <select id="citizenAgeGroup">
                            <option value="0">Child</option>
                            <option value="1" selected>Adult</option>
                            <option value="2">Senior</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>BMI Category</label>
                        <select id="citizenBmiCategory">
                            <option value="0" selected>Normal</option>
                            <option value="1">Overweight</option>
                            <option value="2">Obese</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="citizenBpIndex">Blood Pressure Index (0-1000)</label>
                        <input id="citizenBpIndex" type="number" min="0" max="1000" value="120">
                    </div>

                    <button type="button" class="btn btn-primary" id="btnSubmitCitizen">Submit Citizen</button>
                    <div id="citizenStatus" class="status-text"></div>
                    <div id="citizenInfo" class="info-box"></div>
                </form>
            </div>

            <!-- Card 2: Submit Region -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üó∫Ô∏è</div>
                    <div>
                        <div class="card-title">Submit Region</div>
                        <div class="card-subtitle">Set health thresholds</div>
                    </div>
                </div>

                <form>
                    <div class="form-group">
                        <label>Min Age Group</label>
                        <select id="regionMinAge">
                            <option value="0">Child</option>
                            <option value="1" selected>Adult</option>
                            <option value="2">Senior</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Max BMI Category</label>
                        <select id="regionMaxBmi">
                            <option value="0">Normal</option>
                            <option value="1" selected>Overweight</option>
                            <option value="2">Obese</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="regionMaxBp">Max Blood Pressure Index</label>
                        <input id="regionMaxBp" type="number" min="0" max="1000" value="140">
                    </div>

                    <button type="button" class="btn btn-secondary" id="btnSubmitRegion">Submit Region</button>
                    <div id="regionStatus" class="status-text"></div>
                    <div id="regionInfo" class="info-box"></div>
                </form>
            </div>
        </div>

        <!-- Match & Decrypt Section -->
        <div class="grid">
            <!-- Compute Match -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üîç</div>
                    <div>
                        <div class="card-title">Compute Match</div>
                        <div class="card-subtitle">Homomorphic evaluation</div>
                    </div>
                </div>

                <form>
                    <div class="form-group">
                        <label for="computeCitizenId">Citizen ID</label>
                        <input id="computeCitizenId" type="number" min="1" value="1">
                    </div>

                    <div class="form-group">
                        <label for="computeRegionId">Region ID</label>
                        <input id="computeRegionId" type="number" min="1" value="1">
                    </div>

                    <button type="button" class="btn btn-primary" id="btnComputeMatch">Compute Match</button>
                    <div id="computeStatus" class="status-text"></div>
                    <div id="matchHandleOutput" class="info-box"></div>
                </form>
            </div>

            <!-- Get Handle & Decrypt -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon">üîê</div>
                    <div>
                        <div class="card-title">Decrypt Result</div>
                        <div class="card-subtitle">Finalize & reveal</div>
                    </div>
                </div>

                <form>
                    <div class="form-group">
                        <label for="decryptCitizenId">Citizen ID</label>
                        <input id="decryptCitizenId" type="number" min="1" value="1">
                    </div>

                    <div class="form-group">
                        <label for="decryptRegionId">Region ID</label>
                        <input id="decryptRegionId" type="number" min="1" value="1">
                    </div>

                    <button type="button" class="btn btn-primary" id="btnGetHandle">Get Handle</button>
                    <button type="button" class="btn btn-primary" id="btnMakePublic">Make Public</button>
                    <button type="button" class="btn btn-secondary" id="btnDecrypt">Decrypt</button>
                    <div id="decryptStatus" class="status-text"></div>
                    <div id="decryptResult" class="info-box"></div>
                </form>
            </div>
        </div>

    </div>

      <script type="module">
    // ------------ IMPORTS ------------
    import { initSDK, createInstance, SepoliaConfig } from "https://cdn.zama.org/relayer-sdk-js/0.3.0-5/relayer-sdk-js.js";
    import { BrowserProvider, Contract, getAddress } from "https://cdn.jsdelivr.net/npm/ethers@6.15.0/+esm";

    // ------------ CONFIG ------------
    const CONTRACT_ADDRESS = "0x3A32DDCDA724d8329E139ad60b98432D9C4A0cf2";

    // Minimal ABI tailored to contract functions
    const ABI = [
      "function submitCitizen(bytes32,bytes32,bytes32,bytes) external returns (uint256)",
      "function submitRegion(bytes32,bytes32,bytes32,bytes) external returns (uint256)",
      "function computeHealthMatch(uint256,uint256) external returns (bytes32)",
      "function makeMatchPublic(uint256,uint256) external",
      "function matchHandle(uint256,uint256) external view returns (bytes32)",
      "function citizenExists(uint256) external view returns (bool)",
      "function regionExists(uint256) external view returns (bool)",
      "function citizenOwner(uint256) external view returns (address)",
      "function regionOwner(uint256) external view returns (address)"
    ];

    // ------------ STATE ------------
    let provider, signer, userAddress, contract, relayer;
    const $ = s => document.querySelector(s);

    // ------------ LOG HELPERS (English) ------------
    function logInfo(tag, data){ console.log(`%c[${tag}]`, "color:#60a5fa;font-weight:700;", data); }
    function logError(tag, data){ console.error(`%c[ERROR ${tag}]`, "color:#f87171;font-weight:700;", data); }
    function logOk(tag, data){ console.log(`%c[OK ${tag}]`, "color:#34d399;font-weight:700;", data); }

    // ------------ UTIL: hex conversion for Uint8Array -> 0x...
    function toHex(u8) {
      if (typeof u8 === "string") return u8;
      if (u8 instanceof Uint8Array || Array.isArray(u8)) {
        return "0x" + Array.from(u8).map(b => b.toString(16).padStart(2,"0")).join("");
      }
      return String(u8);
    }

    // ------------ CONNECT WALLET & RELAYER ------------
    async function connect() {
      try {
        logInfo("CONNECT", "Starting connection...");

        if (!window.ethereum) throw new Error("MetaMask not found");
        provider = new BrowserProvider(window.ethereum);
        logInfo("CONNECT", "BrowserProvider created");

        const accounts = await provider.send("eth_requestAccounts", []);
        signer = await provider.getSigner();
        userAddress = await signer.getAddress();
        logInfo("WALLET", `Address: ${userAddress}`);

        contract = new Contract(getAddress(CONTRACT_ADDRESS), ABI, signer);
        logInfo("CONTRACT", `Contract initialized: ${CONTRACT_ADDRESS}`);

        if (!relayer) {
          logInfo("RELAYER", "Initializing SDK...");
          await initSDK();
          relayer = await createInstance({
            ...SepoliaConfig,
            relayerUrl: "https://relayer.testnet.zama.org",
            gatewayUrl: "https://gateway.testnet.zama.org",
            network: window.ethereum,
            debug: true
          });
          logOk("RELAYER", "Relayer instance created");
        }

        $("#btnConnect").textContent = userAddress.slice(0,6) + "‚Ä¶" + userAddress.slice(-4);
        logOk("CONNECT", "Ready");
        return true;
      } catch (e) {
        logError("CONNECT", e);
        alert("Connection failed: " + (e.message || e));
        return false;
      }
    }

    $("#btnConnect").onclick = connect;

    // ------------ SUBMIT CITIZEN ------------
    $("#btnSubmitCitizen").onclick = async () => {
      try {
        logInfo("SUBMIT CITIZEN", "Start");
        if (!await connect()) return;

        $("#citizenStatus").textContent = "Encrypting and submitting...";
        const ageGroup = BigInt(parseInt($("#citizenAgeGroup").value || "1"));
        const bmiCategory = BigInt(parseInt($("#citizenBmiCategory").value || "0"));
        const bpIndex = BigInt(parseInt($("#citizenBpIndex").value || "0"));

        logInfo("CITIZEN VALUES", { ageGroup: ageGroup.toString(), bmiCategory: bmiCategory.toString(), bpIndex: bpIndex.toString() });

        const enc = relayer.createEncryptedInput(getAddress(CONTRACT_ADDRESS), getAddress(userAddress));
        // add8, add8, add16
        enc.add8(ageGroup);
        enc.add8(bmiCategory);
        enc.add16(bpIndex);

        logInfo("ENCRYPT", "Encrypting inputs...");
        const { handles, inputProof } = await enc.encrypt();
        logInfo("ENCRYPT RESULT", { handles, inputProof });

        const h1 = toHex(handles[0]?.handle ?? handles[0]?.ciphertext ?? handles[0]);
        const h2 = toHex(handles[1]?.handle ?? handles[1]?.ciphertext ?? handles[1]);
        const h3 = toHex(handles[2]?.handle ?? handles[2]?.ciphertext ?? handles[2]);
        const att = typeof inputProof === "string" ? (inputProof.startsWith("0x") ? inputProof : "0x"+inputProof) : toHex(inputProof);

        logInfo("HANDLES EXTRACTED", { h1, h2, h3, attPreview: String(att).slice(0,60)+"..." });

        $("#citizenStatus").textContent = "Submitting tx...";
        const tx = await contract.submitCitizen(h1, h2, h3, att);
        logInfo("TX SENT (submitCitizen)", tx.hash);
        const receipt = await tx.wait();
        logOk("TX CONFIRMED", { blockNumber: receipt.blockNumber, status: receipt.status });

        // best-effort id extraction
        let citizenId = "1";
        try {
          if (receipt && receipt.logs && receipt.logs.length > 0) {
            citizenId = receipt.logs[0]?.topics?.[2] ? BigInt(receipt.logs[0].topics[2]).toString() : citizenId;
          }
        } catch (e) {
          logError("ID_EXTRACT", e);
        }

        $("#citizenInfo").style.display = "block";
        $("#citizenInfo").textContent = `Citizen ID: ${citizenId}\nAddress: ${userAddress}\nHandles:\n${h1}\n${h2}\n${h3}`;
        $("#citizenStatus").textContent = "Submitted ‚úì (see console)";
        logOk("SUBMIT CITIZEN", `ID: ${citizenId}`);
      } catch (e) {
        logError("SUBMIT CITIZEN", e);
        $("#citizenStatus").textContent = "Error: " + (e.message || e);
      }
    };

    // ------------ SUBMIT REGION ------------
    $("#btnSubmitRegion").onclick = async () => {
      try {
        logInfo("SUBMIT REGION", "Start");
        if (!await connect()) return;

        $("#regionStatus").textContent = "Encrypting and submitting...";
        const minAge = BigInt(parseInt($("#regionMinAge").value || "1"));
        const maxBmi = BigInt(parseInt($("#regionMaxBmi").value || "1"));
        const maxBp = BigInt(parseInt($("#regionMaxBp").value || "0"));

        logInfo("REGION VALUES", { minAge: minAge.toString(), maxBmi: maxBmi.toString(), maxBp: maxBp.toString() });

        const enc = relayer.createEncryptedInput(getAddress(CONTRACT_ADDRESS), getAddress(userAddress));
        enc.add8(minAge);
        enc.add8(maxBmi);
        enc.add16(maxBp);

        logInfo("ENCRYPT", "Encrypting region inputs...");
        const { handles, inputProof } = await enc.encrypt();
        logInfo("ENCRYPT RESULT", { handles, inputProof });

        const h1 = toHex(handles[0]?.handle ?? handles[0]?.ciphertext ?? handles[0]);
        const h2 = toHex(handles[1]?.handle ?? handles[1]?.ciphertext ?? handles[1]);
        const h3 = toHex(handles[2]?.handle ?? handles[2]?.ciphertext ?? handles[2]);
        const att = typeof inputProof === "string" ? (inputProof.startsWith("0x") ? inputProof : "0x"+inputProof) : toHex(inputProof);

        logInfo("HANDLES EXTRACTED (region)", { h1, h2, h3, attPreview: String(att).slice(0,60)+"..." });

        $("#regionStatus").textContent = "Submitting tx...";
        const tx = await contract.submitRegion(h1, h2, h3, att);
        logInfo("TX SENT (submitRegion)", tx.hash);
        const receipt = await tx.wait();
        logOk("TX CONFIRMED (region)", { blockNumber: receipt.blockNumber, status: receipt.status });

        let regionId = "1";
        try {
          if (receipt && receipt.logs && receipt.logs.length > 0) {
            regionId = receipt.logs[0]?.topics?.[2] ? BigInt(receipt.logs[0].topics[2]).toString() : regionId;
          }
        } catch (e) {
          logError("REGION_ID_EXTRACT", e);
        }

        $("#regionInfo").style.display = "block";
        $("#regionInfo").textContent = `Region ID: ${regionId}\nAddress: ${userAddress}\nHandles:\n${h1}\n${h2}\n${h3}`;
        $("#regionStatus").textContent = "Submitted ‚úì (see console)";
        logOk("SUBMIT REGION", `ID: ${regionId}`);
      } catch (e) {
        logError("SUBMIT REGION", e);
        $("#regionStatus").textContent = "Error: " + (e.message || e);
      }
    };

    // ------------ COMPUTE MATCH ------------
    $("#btnComputeMatch").onclick = async () => {
      try {
        logInfo("COMPUTE MATCH", "Start");
        if (!await connect()) return;

        const citizenId = parseInt($("#computeCitizenId").value || "0");
        const regionId = parseInt($("#computeRegionId").value || "0");
        $("#computeStatus").textContent = "Calling computeHealthMatch...";
        logInfo("COMPUTE ARGS", { citizenId, regionId });

        const tx = await contract.computeHealthMatch(citizenId, regionId);
        logInfo("TX SENT (computeHealthMatch)", tx.hash);
        const receipt = await tx.wait();
        logOk("TX CONFIRMED (computeHealthMatch)", { blockNumber: receipt.blockNumber, status: receipt.status });

        const handle = await contract.matchHandle(citizenId, regionId);
        logInfo("MATCH HANDLE RETRIEVED", handle);

        $("#matchHandleOutput").style.display = "block";
        $("#matchHandleOutput").textContent = "Match Handle:\n" + handle;
        $("#computeStatus").textContent = "Match computed ‚úì";
      } catch (e) {
        logError("COMPUTE MATCH", e);
        $("#computeStatus").textContent = "Error: " + (e.message || e);
      }
    };

    // ------------ GET HANDLE ------------
    $("#btnGetHandle").onclick = async () => {
      try {
        logInfo("GET HANDLE", "Start");
        if (!await connect()) return;

        const citizenId = parseInt($("#decryptCitizenId").value || "0");
        const regionId = parseInt($("#decryptRegionId").value || "0");
        $("#decryptStatus").textContent = "Retrieving handle...";
        const handle = await contract.matchHandle(citizenId, regionId);
        logInfo("HANDLE", handle);

        $("#matchHandleOutput").style.display = "block";
        $("#matchHandleOutput").textContent = "Match Handle:\n" + handle;
        $("#decryptStatus").textContent = "Handle retrieved ‚úì";
      } catch (e) {
        logError("GET HANDLE", e);
        $("#decryptStatus").textContent = "Error: " + (e.message || e);
      }
    };

    // ------------ MAKE PUBLIC ------------
    $("#btnMakePublic").onclick = async () => {
      try {
        logInfo("MAKE PUBLIC", "Start");
        if (!await connect()) return;

        const citizenId = parseInt($("#decryptCitizenId").value || "0");
        const regionId = parseInt($("#decryptRegionId").value || "0");
        $("#decryptStatus").textContent = "Calling makeMatchPublic...";
        const tx = await contract.makeMatchPublic(citizenId, regionId);
        logInfo("TX SENT (makeMatchPublic)", tx.hash);
        const receipt = await tx.wait();
        logOk("TX CONFIRMED (makeMatchPublic)", { blockNumber: receipt.blockNumber, status: receipt.status });
        $("#decryptStatus").textContent = "Match made public ‚úì";
      } catch (e) {
        logError("MAKE PUBLIC", e);
        $("#decryptStatus").textContent = "Error: " + (e.message || e);
      }
    };

    // ------------ PUBLIC DECRYPT ------------
    async function publicDecryptHandle(cleanHandle) {
      if (!relayer) throw new Error("Relayer not initialized");
      const h = String(cleanHandle).trim();
      if (!h.startsWith("0x") || h.length !== 66) throw new Error("Handle must be bytes32 hex (0x...)");

      logInfo("DECRYPT", `Requesting publicDecrypt for ${h}`);
      const req = [ h ];
      logInfo("DECRYPT REQ", req);

      const out = await relayer.publicDecrypt(req);
      logInfo("DECRYPT OUT RAW", out);

      if (!out || typeof out !== "object") throw new Error("Invalid decrypt response");
      if (!out.clearValues) throw new Error("Decrypt response missing clearValues");

      const lower = h.toLowerCase();
      const val = out.clearValues[h] ?? out.clearValues[lower];

      if (val === undefined || val === null) throw new Error("No clear value for handle");

      logInfo("DECRYPT CLEAR VALUE", val);
      return BigInt(val) === 1n;
    }

    $("#btnDecrypt").onclick = async () => {
      try {
        logInfo("DECRYPT BUTTON", "Start");
        if (!await connect()) return;

        const raw = $("#matchHandleOutput").textContent || "";
        const handle = raw.split("\n").pop().trim();
        logInfo("HANDLE TO DECRYPT", handle);

        $("#decryptStatus").textContent = "Decrypting...";
        const isMatch = await publicDecryptHandle(handle);

        $("#decryptResult").style.display = "block";
        if (isMatch) {
          $("#decryptResult").textContent = "‚úÖ MATCH = true";
          $("#decryptResult").style.background = "rgba(16,185,129,0.06)";
        } else {
          $("#decryptResult").textContent = "‚ùå MATCH = false";
          $("#decryptResult").style.background = "rgba(239,68,68,0.06)";
        }
        $("#decryptStatus").textContent = "Decrypt finished ‚úì";
        logOk("DECRYPT RESULT", isMatch);
      } catch (e) {
        logError("DECRYPT", e);
        $("#decryptStatus").textContent = "Error: " + (e.message || e);
      }
    };

    logInfo("SCRIPT", "UI ready ‚Äî handlers attached. All logs in English.");
  </script>
</body>
</html>

